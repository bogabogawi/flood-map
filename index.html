<!DOCTYPE html>
<html>
<head>
  <title>Kelantan Flood Map with User Location</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { height: 100vh; width: 100%; }
    .user-marker {
      background: #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      border: 2px solid white;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    .flood-marker {
      background: #e74c3c;
      border-radius: 50%;
      width: 15px;
      height: 15px;
      border: 2px solid white;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // Initialize map centered on Kelantan
    const map = L.map('map').setView([6.1256, 102.2386], 11);

    // Add OpenStreetMap base layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Flood data for Kelantan (example coordinates)
    const floodData = [
      { name: "Kota Bharu", coords: [6.1256, 102.2386], risk: "High" },
      { name: "Pasir Mas", coords: [6.0493, 102.1399], risk: "Medium" },
      { name: "Kuala Krai", coords: [5.5308, 102.2016], risk: "High" },
      { name: "Tumpat", coords: [6.1978, 102.1710], risk: "Medium" }
    ];

    // Add flood markers with custom styling
    floodData.forEach(area => {
      L.marker(area.coords, {
        icon: L.divIcon({
          className: 'flood-marker',
          html: '<div style="background: ' + (area.risk === "High" ? '#e74c3c' : '#f39c12') + '"></div>'
        })
      })
      .bindPopup(`<b>${area.name}</b><br>Risk Level: ${area.risk}`)
      .addTo(map);
    });

    // Handle user location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userCoords = [position.coords.latitude, position.coords.longitude];
          
          // Add user location marker
          L.marker(userCoords, {
            icon: L.divIcon({
              className: 'user-marker',
              html: '<div></div>'
            }),
            zIndexOffset: 1000
          })
          .bindPopup("You are here!")
          .addTo(map);
          
          // Center map on user with offset to keep Kelantan visible
          map.setView(userCoords, 13);
          
          // Add line from user to nearest flood area (example)
          const nearestFlood = findNearestFlood(userCoords);
          L.polyline([userCoords, nearestFlood.coords], {
            color: '#3498db',
            dashArray: '5, 5'
          }).addTo(map);
        },
        (error) => {
          console.error("Geolocation error:", error);
          alert("Unable to get your location. Defaulting to Kelantan view.");
        },
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        }
      );
    } else {
      alert("Geolocation is not supported by your browser.");
    }

    // Helper function to find nearest flood point (simplified)
    function findNearestFlood(userCoords) {
      return floodData.reduce((nearest, current) => {
        const currentDist = L.latLng(userCoords).distanceTo(L.latLng(current.coords));
        return currentDist < (nearest.distance || Infinity) ? 
               { coords: current.coords, distance: currentDist } : nearest;
      }, {});
    }
  </script>
</body>
</html>
